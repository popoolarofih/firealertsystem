<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Live Tracking / Map - Fire Alert System</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Google Fonts: Space Grotesk -->
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Space Grotesk', sans-serif;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #map {
      height: 100vh;
      width: 100%;
    }
    /* Sidebar Overlay for Alert Details */
    .sidebar {
      position: absolute;
      top: 60px;
      right: 0;
      width: 300px;
      height: calc(100vh - 60px);
      background-color: rgba(255, 255, 255, 0.95);
      overflow-y: auto;
      padding: 15px;
      box-shadow: -2px 0 5px rgba(0,0,0,0.3);
      z-index: 5;
    }
    .sidebar h4 {
      margin-bottom: 15px;
    }
    .alert-item {
      border-bottom: 1px solid #ddd;
      padding: 10px 0;
      margin-bottom: 10px;
    }
    .alert-item:last-child {
      border-bottom: none;
    }
    .alert-buttons button {
      margin-right: 5px;
    }
  </style>
  
  <!-- Firebase App and Realtime Database -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getDatabase, ref, onChildAdded, remove } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
    
    // Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBNaGEyujkZ85znKRXLqJOhD0yOR3GM9pE",
      authDomain: "fir-eaef9.firebaseapp.com",
      projectId: "fir-eaef9",
      storageBucket: "fir-eaef9.firebasestorage.app",
      messagingSenderId: "437370217594",
      appId: "1:437370217594:web:e16fb56996d45b988807c3",
      measurementId: "G-1VHVSL6DEX"
    };
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    window.database = database; // Expose for debugging if needed
  </script>
  
  <!-- Google Maps API (Replace with your actual API key) -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDqBl2wJF_hzo_bGqesT8Ep94k9urE08Yk&callback=initMap"></script>
</head>
<body>
  <div id="map"></div>
  
  <!-- Sidebar for alert details -->
  <div class="sidebar">
    <h4>Active Alerts</h4>
    <div id="alertList">
      <!-- Alert items will be appended here -->
    </div>
  </div>
  
  <!-- Bootstrap Bundle with Popper.js -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    let map;
    let userMarker;
    let alertMarkers = {}; // Tracks alert markers by Firebase key
    let infoWindows = {};  // Tracks info windows for each alert
    
    // Initialize Google Map
    function initMap() {
      // Default center (e.g., Lagos coordinates)
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 6.5244, lng: 3.3792 },
        zoom: 12,
      });
      
      // Get user's current location using the Geolocation API with options for higher accuracy
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          (position) => {
            const pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };
            console.log("User location:", pos);
            // Place or update the user's marker
            if (!userMarker) {
              userMarker = new google.maps.Marker({
                position: pos,
                map: map,
                icon: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                title: "You are here",
              });
            } else {
              userMarker.setPosition(pos);
            }
            // Optionally, center the map on user's location
            map.setCenter(pos);
          },
          (error) => {
            console.error("Error fetching geolocation: ", error);
          },
          { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
        );
      } else {
        console.error("Geolocation is not supported by this browser.");
      }
      
      // Listen for alert data from Firebase Realtime Database
      const alertsRef = ref(database, 'alerts');
      onChildAdded(alertsRef, (data) => {
        const alertData = data.val();
        const alertKey = data.key;
        
        // Create a marker for this alert if not already added
        if (!alertMarkers[alertKey]) {
          const marker = new google.maps.Marker({
            position: { lat: alertData.lat, lng: alertData.lng },
            map: map,
            icon: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
            title: alertData.description || "Alert",
          });
          alertMarkers[alertKey] = marker;
          
          // Create an info window for the marker with an Open button
          const infoWindow = new google.maps.InfoWindow({
            content: `<div>
                        <strong>${alertData.description || "Alert"}</strong><br>
                        Time: ${new Date(alertData.timestamp).toLocaleString()}<br>
                        <button class="btn btn-sm btn-primary" onclick="openAlert('${alertKey}')">Open</button>
                      </div>`
          });
          infoWindows[alertKey] = infoWindow;
          
          marker.addListener("click", () => {
            infoWindow.open(map, marker);
          });
          
          // Add alert details to sidebar with Cancel and Open buttons
          addAlertToSidebar(alertData, alertKey);
        }
      });
    }
    
    // Function to open an alert (centers map and opens info window)
    function openAlert(alertKey) {
      if (alertMarkers[alertKey]) {
        map.setCenter(alertMarkers[alertKey].getPosition());
        infoWindows[alertKey].open(map, alertMarkers[alertKey]);
      }
    }
    
    // Function to cancel (remove) an alert from the map and sidebar
    function cancelAlert(alertKey) {
      // Remove marker from map
      if (alertMarkers[alertKey]) {
        alertMarkers[alertKey].setMap(null);
        delete alertMarkers[alertKey];
      }
      // Close and remove info window
      if (infoWindows[alertKey]) {
        infoWindows[alertKey].close();
        delete infoWindows[alertKey];
      }
      // Remove alert item from sidebar
      const alertItem = document.getElementById("alert-" + alertKey);
      if (alertItem) {
        alertItem.remove();
      }
      // Optionally, remove the alert from Firebase
      const alertRef = ref(database, 'alerts/' + alertKey);
      remove(alertRef);
    }
    
    // Append alert details to the sidebar with Cancel and Open buttons
    function addAlertToSidebar(alertData, alertKey) {
      const alertList = document.getElementById("alertList");
      const alertItem = document.createElement("div");
      alertItem.className = "alert-item";
      alertItem.id = "alert-" + alertKey;
      alertItem.innerHTML = `
        <strong>${alertData.description || "Alert"}</strong><br>
        ${new Date(alertData.timestamp).toLocaleString()}<br>
        <div class="alert-buttons mt-2">
          <button class="btn btn-sm btn-primary" onclick="openAlert('${alertKey}')">Open</button>
          <button class="btn btn-sm btn-danger" onclick="cancelAlert('${alertKey}')">Cancel</button>
        </div>
      `;
      alertList.appendChild(alertItem);
    }
  </script>
</body>
</html>
